<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test Completo RestoApp</title>
    <style>body{font-family: sans-serif; padding: 20px;} input, button {padding: 10px; margin: 5px;} #resultado, #kds {margin-top: 20px; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap;}</style>
</head>
<body>
    <h1>Test del Backend de RestoApp</h1>
    
    <h2>1. Iniciar Sesión (Admin/Mozo)</h2>
    <input type="email" id="email" placeholder="Email" value="admin.bonito@restoapp.com">
    <input type="password" id="password" placeholder="Contraseña" value="miClaveDePrueba123">
    <button onclick="login()">Login</button>
    <div id="resultado"></div>

    <hr>
    
    <h2>Simulador KDS (Pantalla de Cocina)</h2>
    <button onclick="conectarKDS()">Conectar y Unirse a Sala Cocina</button>
    <div id="kds">Esperando conexión y nuevas comandas...</div>

    <!-- Importamos la librería de socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        let token = null;
        let socket = null;
        const resultadoDiv = document.getElementById('resultado');
        const kdsDiv = document.getElementById('kds');
        const API_URL = 'http://200.58.121.205:3523';

        // --- Lógica de Login (ya la teníamos) ---
        async function login() { /* ... el código de login se queda igual ... */ }
        
        // --- ¡NUEVA LÓGICA DE WEBSOCKETS! ---
        function conectarKDS() {
            // Si ya hay un socket, lo desconectamos para empezar de cero
            if (socket) socket.disconnect();

            // Creamos la conexión WebSocket
            socket = io(API_URL, {
                transports: ['websocket'], // Forzamos el uso de websockets
            });

            socket.on('connect', () => {
                kdsDiv.innerText = 'KDS Conectado al servidor. Uniéndose a la sala de cocina...';
                // Una vez conectados, enviamos el mensaje para unirnos a la sala
                socket.emit('join_cocina');
            });

            // Escuchamos el evento 'nueva_comanda' que envía el backend
            socket.on('nueva_comanda', (comanda) => {
                console.log('¡Nueva comanda recibida!', comanda);
                const comandaHtml = document.createElement('div');
                comandaHtml.style.border = '2px solid red';
                comandaHtml.style.padding = '10px';
                comandaHtml.style.margin = '10px 0';
                comandaHtml.innerHTML = `
                    <h3>Nueva Comanda #${comanda.id.substring(0, 8)}</h3>
                    <pre>${JSON.stringify(comanda.items, null, 2)}</pre>
                `;
                kdsDiv.appendChild(comandaHtml);
            });

            socket.on('disconnect', () => {
                kdsDiv.innerText = 'KDS Desconectado.';
            });
        }

        // Copia y pega aquí la función login() completa de nuestro archivo anterior
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                const response = await fetch(`${API_URL}/auth/v1/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Error en el login');
                token = data.access_token;
                resultadoDiv.innerText = '¡Login exitoso! Token guardado.';
            } catch (error) {
                resultadoDiv.innerText = 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>